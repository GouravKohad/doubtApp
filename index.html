<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Doubts App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-100">
  <div id="app" class="max-w-2xl mx-auto p-4"></div>

<script>
  // ‚úÖ Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAgCjl2vqr1k_X7uFXx6_wx5czRat3-0jg",
    authDomain: "doubtapp-a95cb.firebaseapp.com",
    projectId: "doubtapp-a95cb",
    storageBucket: "doubtapp-a95cb.appspot.com",
    messagingSenderId: "111015534504",
    appId: "1:111015534504:web:db636e140519dc5f48c79d",
    measurementId: "G-KCN7PPNYS2"
  };

  // üî• Init Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const appDiv = document.getElementById("app");

  // ‚úÖ Render Login UI
  function renderLogin() {
    appDiv.innerHTML = `
      <div class="flex justify-center mt-20">
        <button id="loginBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow">
          Sign in with Google
        </button>
      </div>
    `;
    document.getElementById("loginBtn").onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    };
  }

  // ‚úÖ Render Main UI
  function renderApp(user) {
    appDiv.innerHTML = `
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Student Doubts</h1>
        <button id="logoutBtn" class="text-sm underline">Logout</button>
      </div>

      <!-- Leaderboard -->
      <div id="leaderboard" class="bg-white p-3 rounded-xl shadow mb-6"></div>

      <!-- Post box -->
      <div class="bg-white shadow rounded-xl p-4 mb-6">
        <textarea id="postText" class="w-full p-2 border rounded-lg" placeholder="Ask a doubt..."></textarea>
        <input id="postImage" type="file" accept="image/*" class="mt-2">
        <button id="postBtn" class="bg-blue-600 text-white px-4 py-1 rounded-lg mt-2">Post</button>
      </div>

      <!-- Feed -->
      <div id="feed"></div>
    `;

    document.getElementById("logoutBtn").onclick = () => auth.signOut();
    document.getElementById("postBtn").onclick = handlePost;
    loadPosts();
  }

  // ‚úÖ Post a new doubt
  async function handlePost() {
    const text = document.getElementById("postText").value;
    const file = document.getElementById("postImage").files[0];
    if (!text && !file) return;

    let imageUrl = null;
    if (file) {
      const ref = storage.ref("posts/" + Date.now() + "-" + file.name);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }

    await db.collection("posts").add({
      text,
      image: imageUrl,
      uid: auth.currentUser.uid,
      author: auth.currentUser.displayName,
      likes: 0,
      comments: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });

    document.getElementById("postText").value = "";
    document.getElementById("postImage").value = "";
  }

  // ‚úÖ Load posts
  function loadPosts() {
    db.collection("posts").orderBy("createdAt","desc").onSnapshot((snap) => {
      const posts = [];
      const scores = {};
      snap.forEach((doc) => {
        const p = {id: doc.id, ...doc.data()};
        posts.push(p);
        if (p.uid) {
          if (!scores[p.uid]) scores[p.uid] = { name: p.author, score: 0 };
          scores[p.uid].score += (p.likes||0) + (p.accepted ? 5 : 0);
        }
      });
      renderPosts(posts);
      renderLeaderboard(Object.values(scores).sort((a,b)=>b.score-a.score));
    });
  }

  // ‚úÖ Render posts
  function renderPosts(posts) {
    const feed = document.getElementById("feed");
    feed.innerHTML = "";
    posts.forEach((post) => {
      const div = document.createElement("div");
      div.className = "bg-white shadow rounded-xl p-4 mb-4";
      div.innerHTML = `
        <p class="font-semibold">${post.author}</p>
        <p>${post.text||""}</p>
        ${post.image ? `<img src="${post.image}" class="rounded-lg mt-2"/>` : ""}
        <div class="flex items-center gap-4 mt-3 text-gray-600">
          <button class="likeBtn flex items-center gap-1 hover:text-blue-600" data-id="${post.id}">
            üëç ${post.likes}
          </button>
          <span>üí¨ ${post.comments?.length||0}</span>
        </div>
        <div class="mt-3" id="comments-${post.id}">
          ${(post.comments||[]).map(c => `
            <div class="text-sm bg-gray-100 p-2 rounded-lg mb-1">
              <span class="font-semibold">${c.author}: </span>${c.text||""}
              ${c.file ? `<audio controls src="${c.file}" class="mt-1"></audio>` : ""}
            </div>
          `).join("")}
          <input id="cmtText-${post.id}" class="border p-1 rounded-lg w-full mt-1" placeholder="Write a comment..."/>
          <input id="cmtFile-${post.id}" type="file" accept="audio/*" class="mt-1"/>
          <button class="sendCmt bg-blue-600 text-white px-3 py-1 rounded-lg mt-1" data-id="${post.id}">Send</button>
        </div>
      `;
      feed.appendChild(div);
    });

    document.querySelectorAll(".likeBtn").forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.id;
        db.collection("posts").doc(id).update({ likes: firebase.firestore.FieldValue.increment(1) });
      };
    });

    document.querySelectorAll(".sendCmt").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        const text = document.getElementById("cmtText-"+id).value;
        const file = document.getElementById("cmtFile-"+id).files[0];
        let fileUrl = null;
        if (file) {
          const ref = storage.ref("comments/" + Date.now() + "-" + file.name);
          await ref.put(file);
          fileUrl = await ref.getDownloadURL();
        }
        await db.collection("posts").doc(id).update({
          comments: firebase.firestore.FieldValue.arrayUnion({
            uid: auth.currentUser.uid,
            author: auth.currentUser.displayName,
            text,
            file: fileUrl,
            createdAt: Date.now()
          })
        });
        document.getElementById("cmtText-"+id).value="";
        document.getElementById("cmtFile-"+id).value="";
      };
    });
  }

  // ‚úÖ Render leaderboard
  function renderLeaderboard(leaders) {
    const lb = document.getElementById("leaderboard");
    lb.innerHTML = `
      <h2 class="font-semibold mb-2">üèÜ Leaderboard</h2>
      ${leaders.map((l,i)=>`
        <div class="flex justify-between text-sm mb-1">
          <span>${i+1}. ${l.name}</span>
          <span>${l.score} pts</span>
        </div>
      `).join("")}
    `;
  }

  // üîÑ Auth state listener
  auth.onAuthStateChanged(user => {
    if (!user) renderLogin();
    else renderApp(user);
  });
</script>
</body>
</html>
