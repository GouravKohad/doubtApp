<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Student Doubts</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

  <div id="app" class="w-full max-w-2xl"></div>

<script>
  // üî• Firebase Config (yours)
  const firebaseConfig = {
    apiKey: "AIzaSyAgCjl2vqr1k_X7uFXx6_wx5czRat3-0jg",
    authDomain: "doubtapp-a95cb.firebaseapp.com",
    projectId: "doubtapp-a95cb",
    storageBucket: "doubtapp-a95cb.appspot.com", // ‚úÖ fixed
    messagingSenderId: "111015534504",
    appId: "1:111015534504:web:db636e140519dc5f48c79d",
    measurementId: "G-KCN7PPNYS2"
  };

  // Init
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const storage = firebase.storage();
  const provider = new firebase.auth.GoogleAuthProvider();

  const appDiv = document.getElementById("app");
  let currentUser = null;

  // üîê Auth listener
  auth.onAuthStateChanged(user => {
    currentUser = user;
    render();
  });

  // üì° Posts listener
  db.collection("posts").orderBy("createdAt","desc").onSnapshot(snap => {
    posts = snap.docs.map(d => ({id:d.id,...d.data()}));
    render();
  });

  let posts = [];

  // üìù Add post
  async function addPost(text, file) {
    let imageUrl = null;
    if(file){
      const ref = storage.ref("posts/"+Date.now()+"-"+file.name);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }
    await db.collection("posts").add({
      text, image:imageUrl,
      uid: currentUser.uid,
      author: currentUser.displayName,
      likes:0, comments:[],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  // ‚ù§Ô∏è Like
  async function likePost(id, likes){
    await db.collection("posts").doc(id).update({likes:likes+1});
  }

  // üí¨ Comment
  async function addComment(postId,text,file){
    let fileUrl=null;
    if(file){
      const ref = storage.ref("comments/"+Date.now()+"-"+file.name);
      await ref.put(file);
      fileUrl = await ref.getDownloadURL();
    }
    const refDoc = db.collection("posts").doc(postId);
    await refDoc.update({
      comments: firebase.firestore.FieldValue.arrayUnion({
        uid: currentUser.uid,
        author: currentUser.displayName,
        text, file:fileUrl,
        createdAt: Date.now()
      })
    });
  }

  // üé® Render UI
  function render(){
    if(!currentUser){
      appDiv.innerHTML = `
        <div class="flex justify-center mt-20">
          <button onclick="auth.signInWithPopup(provider)" 
            class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow">
            Sign in with Google
          </button>
        </div>`;
      return;
    }

    // Leaderboard
    const scores={};
    posts.forEach(p=>{
      if(!p.uid) return;
      if(!scores[p.uid]) scores[p.uid]={name:p.author,score:0};
      scores[p.uid].score+=(p.likes||0)+(p.accepted?5:0);
    });
    const leaders = Object.values(scores).sort((a,b)=>b.score-a.score);

    appDiv.innerHTML = `
      <div class="flex justify-between mb-4">
        <h1 class="text-2xl font-bold">Student Doubts</h1>
        <button onclick="auth.signOut()" class="text-sm underline">Logout</button>
      </div>

      <div class="bg-white p-3 rounded-xl shadow mb-6">
        <h2 class="font-semibold mb-2">üèÜ Leaderboard</h2>
        ${leaders.map((l,i)=>`
          <div class="flex justify-between text-sm mb-1">
            <span>${i+1}. ${l.name}</span><span>${l.score} pts</span>
          </div>`).join("")}
      </div>

      <div class="bg-white shadow rounded-xl p-4 mb-6">
        <textarea id="postText" class="w-full p-2 border rounded-lg" placeholder="Ask a doubt..."></textarea>
        <input type="file" id="postFile" class="mt-2"/>
        <button onclick="handlePost()" class="bg-blue-600 text-white px-4 py-1 rounded-lg mt-2">Post</button>
      </div>

      ${posts.map(p=>`
        <div class="bg-white shadow rounded-xl p-4 mb-4">
          <p class="font-semibold">${p.author||""}</p>
          <p>${p.text||""}</p>
          ${p.image?`<img src="${p.image}" class="rounded-lg mt-2"/>`:""}
          <div class="flex items-center gap-4 mt-3 text-gray-600">
            <button onclick="likePost('${p.id}',${p.likes||0})" 
              class="hover:text-blue-600">üëç ${p.likes||0}</button>
            <span>üí¨ ${p.comments?p.comments.length:0}</span>
          </div>
          <div class="mt-3">
            ${(p.comments||[]).map(c=>`
              <div class="text-sm bg-gray-100 p-2 rounded-lg mb-1">
                <span class="font-semibold">${c.author}: </span>${c.text||""}
                ${c.file?`<audio controls src="${c.file}" class="mt-1"></audio>`:""}
              </div>`).join("")}
            <div class="flex flex-col gap-2 mt-2">
              <input id="cmt-${p.id}" class="border p-1 rounded-lg" placeholder="Write a comment..."/>
              <input type="file" id="cmtfile-${p.id}" accept="audio/*"/>
              <button onclick="handleComment('${p.id}')" 
                class="bg-blue-600 text-white px-3 py-1 rounded-lg">Send</button>
            </div>
          </div>
        </div>
      `).join("")}
    `;
  }

  // üõ† Handlers
  async function handlePost(){
    const text=document.getElementById("postText").value;
    const file=document.getElementById("postFile").files[0];
    await addPost(text,file);
    document.getElementById("postText").value="";
    document.getElementById("postFile").value="";
  }
  async function handleComment(postId){
    const text=document.getElementById("cmt-"+postId).value;
    const file=document.getElementById("cmtfile-"+postId).files[0];
    await addComment(postId,text,file);
    document.getElementById("cmt-"+postId).value="";
    document.getElementById("cmtfile-"+postId).value="";
  }
</script>
</body>
</html>
